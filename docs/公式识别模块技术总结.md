# 公式识别模块技术总结

## 一、模块概述

公式识别模块是OCR（光学字符识别）系统中的关键组成部分，负责将图像中的数学公式转换为可编辑的文本或计算机可识别的格式。该模块输出数学公式的 LaTeX 或 MathML 代码，作为文本理解模块的输入。模块性能直接影响整个OCR系统的准确性和效率。

## 二、支持模型列表

### 2.1 模型性能对比

| 模型名称 | En-BLEU(%) | Zh-BLEU(%) | GPU推理耗时(ms) | CPU推理耗时(ms) | 模型大小(MB) | 主要特点 |
|---------|-----------|-----------|---------------|---------------|------------|---------|
| UniMERNet | 85.91 | 43.50 | 1311.84 | 8288.07 | 1530 | 上海AI Lab研发，Donut Swin编码器+MBartDecoder |
| PP-FormulaNet-S | 87.00 | 45.71 | 182.25 | 254.39 | 224 | PP-HGNetV2-B4骨干网络，速度优化 |
| PP-FormulaNet-L | 90.36 | 45.78 | 1482.03 | 3131.54 | 695 | Vary_VIT_B骨干网络，复杂公式识别优化 |
| PP-FormulaNet_plus-S | 88.71 | 53.32 | 179.20 | 260.99 | 248 | 增强版，专注英文公式识别 |
| PP-FormulaNet_plus-M | 91.45 | 89.76 | 1040.27 | 1615.80 | 592 | 支持中文公式，token数扩展至2560 |
| PP-FormulaNet_plus-L | 92.22 | 90.64 | 1476.07 | 3125.58 | 698 | 最高精度，中英文支持 |
| LaTeX_OCR_rec | 74.55 | 39.96 | 1088.89 | - | 99 | Hybrid ViT+Transformer架构 |

### 2.2 模型架构特点

#### PP-FormulaNet系列
- **PP-FormulaNet-S/L**：百度飞桨视觉团队开发，支持5万个常见LaTeX源码词汇
- **PP-FormulaNet_plus系列**：增强版模型，使用更丰富的公式数据集训练
  - 支持中文学位论文、专业书籍、教材试卷、数学期刊等多种来源
  - M/L版本新增中文公式支持
  - 最大预测token数从1024扩展至2560

#### UniMERNet
- 上海AI Lab研发
- 采用Donut Swin作为编码器，MBartDecoder作为解码器
- 在包含简单公式、复杂公式、扫描捕捉公式和手写公式的一百万数据集上训练

#### LaTeX_OCR_rec
- 基于自回归大模型的公式识别算法
- 采用Hybrid ViT作为骨干网络，transformer作为解码器

## 三、测试环境

### 3.1 硬件配置
- **GPU**：NVIDIA Tesla T4
- **CPU**：Intel Xeon Gold 6271C @ 2.60GHz

### 3.2 软件环境
- **操作系统**：Ubuntu 20.04
- **CUDA**：11.8
- **cuDNN**：8.9
- **TensorRT**：8.6.1.6
- **paddlepaddle**：3.0.0
- **paddleocr**：3.0.3

### 3.3 推理模式

| 模式 | GPU配置 | CPU配置 | 加速技术组合 |
|------|---------|---------|-------------|
| 常规模式 | FP32精度/无TRT加速 | FP32精度/8线程 | PaddleInference |
| 高性能模式 | 最优精度和加速策略组合 | FP32精度/8线程 | 最优后端(Paddle/OpenVINO/TRT等) |

## 四、使用方法

### 4.1 快速体验

```bash
paddleocr formula_recognition -i https://paddle-model-ecology.bj.bcebos.com/paddlex/imgs/demo_image/general_formula_rec_001.png
```

### 4.2 编程集成

```python
from paddleocr import FormulaRecognition

# 初始化模型
model = FormulaRecognition(model_name="PP-FormulaNet_plus-M")

# 进行预测
output = model.predict(input="general_formula_rec_001.png", batch_size=1)

# 处理结果
for res in output:
    res.print()  # 打印结果
    res.save_to_img(save_path="./output/")  # 保存可视化图像
    res.save_to_json(save_path="./output/res.json")  # 保存JSON结果
```

### 4.3 输入格式支持

- **图像文件**：支持常见图像格式
- **PDF文件**：支持PDF文档中的公式识别
- **URL链接**：支持网络图像资源
- **批量处理**：支持列表形式的批量输入
- **NumPy数组**：支持直接输入图像数组数据

### 4.4 输出结果格式

```json
{
    "res": {
        "input_path": "/path/to/formula_image.png",
        "page_index": null,
        "rec_formula": "\\zeta_{0}(\\nu)=-\\frac{\\nu\\varrho^{-2\\nu}}{\\pi}\\int_{\\mu}^{\\infty}d\\omega\\int_{C_{+}}d z\\frac{2z^{2}}{(z^{2}+\\omega^{2})^{\\nu+1}}\\breve{\\Psi}(\\omega;z)e^{i\\epsilon z}\\quad,"
    }
}
```

## 五、参数配置

### 5.1 模型初始化参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| model_name | str\|None | None | 模型名称，默认PP-FormulaNet_plus-M |
| model_dir | str\|None | None | 模型存储路径 |
| device | str\|None | None | 推理设备（cpu/gpu/npu） |
| enable_hpi | bool | False | 是否启用高性能推理 |
| use_tensorrt | bool | False | 是否启用TensorRT加速 |
| precision | str | "fp32" | 计算精度（fp32/fp16） |
| enable_mkldnn | bool | True | 是否启用MKL-DNN加速 |
| mkldnn_cache_capacity | int | 10 | MKL-DNN缓存容量 |
| cpu_threads | int | 10 | CPU推理线程数 |

### 5.2 预测方法参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| input | Python Var\|str\|list | 必填 | 待预测数据 |
| batch_size | int | 1 | 批大小 |

## 六、结果处理

### 6.1 结果对象方法

- **print()**：打印结果到终端
- **save_to_json()**：保存结果为JSON文件
- **save_to_img()**：保存可视化图像

### 6.2 结果对象属性

- **json**：获取JSON格式的预测结果
- **img**：获取可视化图像数据

## 七、可视化环境配置

如需可视化功能，需安装LaTeX渲染环境（仅支持Ubuntu）：

```bash
sudo apt-get update
sudo apt-get install texlive texlive-latex-base texlive-xetex latex-cjk-all texlive-latex-extra -y
```

## 八、二次开发

### 8.1 环境配置

```bash
# 安装Linux依赖
sudo apt-get update
sudo apt-get install libmagickwand-dev

# 安装Python依赖
pip install tokenizers==0.19.1 imagesize ftfy Wand
```

### 8.2 数据集准备

```bash
# 下载示例数据集
wget https://paddle-model-ecology.bj.bcebos.com/paddlex/data/ocr_rec_latexocr_dataset_example.tar
tar -xf ocr_rec_latexocr_dataset_example.tar
```

### 8.3 预训练模型下载

```bash
# 下载PP-FormulaNet_plus-M预训练模型
wget https://paddleocr.bj.bcebos.com/contribution/rec_ppformulanet_plus_m_train.tar
tar -xf rec_ppformulanet_plus_m_train.tar
```

### 8.4 模型训练

```bash
# 单卡训练
python3 tools/train.py -c configs/rec/PP-FormuaNet/PP-FormulaNet_plus-M.yaml \
   -o Global.pretrained_model=./rec_ppformulanet_plus_m_train/best_accuracy.pdparams

# 多卡训练
python3 -m paddle.distributed.launch --gpus '0,1,2,3' tools/train.py \
   -c configs/rec/PP-FormuaNet/PP-FormulaNet_plus-M.yaml \
   -o Global.pretrained_model=./rec_ppformulanet_plus_m_train/best_accuracy.pdparams
```

### 8.5 模型评估

```bash
python3 tools/eval.py -c configs/rec/PP-FormuaNet/PP-FormulaNet_plus-M.yaml \
   -o Global.pretrained_model=./rec_ppformulanet_plus_m_train/best_accuracy.pdparams
```

### 8.6 模型导出

```bash
python3 tools/export_model.py -c configs/rec/PP-FormuaNet/PP-FormulaNet_plus-M.yaml \
   -o Global.pretrained_model=./rec_ppformulanet_plus_m_train/best_accuracy.pdparams \
   Global.save_inference_dir="./PP-FormulaNet_plus-M_infer/"
```

## 九、模型选择建议

### 9.1 英文场景
- **高精度需求**：PP-FormulaNet-L 或 PP-FormulaNet_plus-L
- **速度优先**：PP-FormulaNet-S 或 PP-FormulaNet_plus-S

### 9.2 中文场景
- **高精度需求**：PP-FormulaNet_plus-L 或 PP-FormulaNet_plus-M
- **平衡性能**：PP-FormulaNet_plus-M

### 9.3 资源受限环境
- **算力有限**：PP-FormulaNet-S
- **存储有限**：LaTeX_OCR_rec（99MB）

## 十、常见问题

### Q1: 推荐使用哪个公式识别模型？
**A1**: 推荐使用PP-FormulaNet系列模型：
- 英文场景且不考虑推理耗时：PP-FormulaNet-L或PP-FormulaNet_plus-L
- 中文场景：PP-FormulaNet_plus-L或PP-FormulaNet_plus-M
- 算力有限的英文场景：PP-FormulaNet-S

### Q2: 为什么推理报错？
**A2**: 公式识别模型推理强依赖于Paddle框架3.0正式版，请确保版本一致。

### Q3: 为什么预测后没有可视化图像？
**A3**: 可能是因为没有安装LaTeX导致，需要安装LaTeX渲染工具。目前公式识别模块可视化只支持Ubuntu环境。

## 十一、技术优势

1. **多模型支持**：提供7种不同性能和特点的模型选择
2. **中英文支持**：PP-FormulaNet_plus系列专门优化中文公式识别
3. **高精度识别**：最高En-BLEU达到92.22%，Zh-BLEU达到90.64%
4. **灵活部署**：支持CPU/GPU多种部署方式
5. **可视化支持**：提供LaTeX渲染的可视化结果
6. **二次开发**：提供完整的训练、评估、导出流程
7. **多格式输入**：支持图像、PDF、URL等多种输入格式

## 十二、注意事项

1. 确保使用Paddle框架3.0正式版
2. 可视化功能仅支持Ubuntu环境
3. 复杂公式的LaTeX结果可能在Markdown环境中无法完全显示
4. 训练需要额外的依赖和配置
5. 模型选择需根据实际场景和资源条件权衡
6. 中文公式识别建议使用PP-FormulaNet_plus系列模型