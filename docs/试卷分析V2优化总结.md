# 试卷分析 V2 版本优化总结

## 概述

`test_exam_paper_analysis_vl_ocr_v2.py` 在 `test_exam_paper_analysis_vl_ocr.py` 的基础上，增加了 **OCR 精确拆分** 功能，解决了 PaddleOCR VL API 将多道题目合并到同一个文本块的问题。

---

## V2 相比 V1 的核心优化点

### 1. 新增 OCR 精确拆分流程（Step 2）

**问题背景：**
- V1 版本依赖 PaddleOCR VL API 进行版面检测和文本识别
- VL API 有时会将多道题目（如"1. xxx 2. xxx 3. xxx"）合并到单个文本块
- 导致后续 Qwen-VL 语义聚合时无法正确拆分，一个 question 组包含多道题目

**V2 解决方案：**
- 在 PaddleOCR VL 检测之后，VL 语义聚合之前，插入 **OCR 精确拆分** 步骤
- 使用本地 PaddleOCR + 规则检测 + VL 辅助判断，将合并的题目精确拆分
- 基于 OCR 行级坐标（`rec_polys`）进行空间精确拆分

### 2. 新增数据结构字段

```python
@dataclass
class DetectionBlock:
    # V1 已有字段
    id: int
    bbox: List[int]
    text: str
    label: str
    block_order: Optional[int]
    group_id: Optional[int]

    # ✨ V2 新增字段
    question_number: Optional[int] = None      # 题号（拆分后的块）
    split_from_merged: bool = False             # 是否由拆分产生
```

### 3. 新增核心组件

#### 3.1 OCRBasedSplitter（基于 OCR 的精确拆分器）
- **功能：** 使用本地 PaddleOCR 获取行级坐标，精确计算每道题目的 bbox
- **输入：** 待拆分的文本块 + 题号列表 + 原始图像
- **输出：** 拆分后的子块列表（每道题目独立成块）
- **核心方法：**
  - `_get_precise_sub_bbox_with_ocr()`: 基于 OCR 行级坐标计算精确 bbox
  - `_contains_question_number()`: 检查文本是否包含指定题号
  - `_convert_poly_to_bbox()`: 四点坐标 → 矩形 bbox

#### 3.2 ContextAwareSplitter（基于规则的拆分器）
- **功能：** 检测文本中的题号，支持规则过滤 + VL 辅助判断
- **题号检测模式：**
  1. **首行限制检测**（strict_line_start=True）：题号必须在行首
  2. **无首行限制检测**（strict_line_start=False）：题号可以在文本任意位置
- **混合策略：**
  - 如果两种检测结果一致 → 使用首行限制结果（更准确）
  - 如果结果不一致 → 调用 VL 模型辅助判断
- **核心方法：**
  - `detect_and_validate()`: 检测并验证题号（混合方案）
  - `_detect_question_numbers()`: 正则匹配题号
  - `_validate_question_sequence()`: 验证题号合理性
  - `_detect_with_vl()`: VL 视觉辅助检测

### 4. 流程对比

| 步骤 | V1 流程 | V2 流程 |
|------|---------|---------|
| Step 1 | PaddleOCR VL API 检测+识别 | ✅ 同 V1 |
| **Step 2** | ❌ 无 | ✨ **OCR 精确拆分**（新增） |
| Step 3 | 绘制 ID 标记图 | ✅ 同 V1（但块数可能增加） |
| Step 4 | VL 语义聚合 | ✅ 同 V1（但输入的块已被拆分） |
| Step 5 | 后处理合并 | ✅ 同 V1 |

### 5. 数据保存增强

V2 版本额外保存了拆分后的数据：

- `{image_name}_v2_paddle_raw.json`: PaddleOCR 原始数据（Step 1 输出）
- **✨ `{image_name}_v2_split.json`**: 拆分后的数据（Step 2 输出，新增）
- `{image_name}_v2_marked.jpg`: ID 标记图（包含拆分后的块）
- `{image_name}_v2_result.json`: 最终结果（包含 `question_number` 和 `split_from_merged` 字段）

---

## Step 2: OCR 精确拆分逻辑详解

### 整体流程

Step 2 的核心任务是将 PaddleOCR VL API 合并的多题文本块拆分为独立的题目块，流程如下：

1. **题号检测** → 使用正则表达式检测文本中的题号（如"1."、"2."、"第3题"等）
2. **检测验证** → 对比"首行限制"和"无首行限制"两种检测结果，结果不一致时调用 VL 模型辅助判断
3. **OCR 精确定位** → 使用本地 PaddleOCR 获取行级坐标，计算每道题目的精确边界框（bbox）
4. **子块生成** → 根据 bbox 和题号创建独立的子块，替换原始合并块

### 核心步骤详解

#### 步骤 1: 题号检测（规则 + VL 混合策略）

**支持的题号格式：**
- 数字加点/顿号：`1.`、`1、`
- 括号格式：`(1)`、`[1]`、`【1】`
- 文字格式：`第1题`

**双重检测机制：**

1. **首行限制检测**：只匹配出现在行首的题号（更准确，避免误匹配文本内容中的数字）
   - 示例：✅ 换行后的 `1. xxx` ❌ 句中的 `共1.5万`

2. **无首行限制检测**：匹配文本任意位置的题号（召回率更高，但可能误匹配）
   - 示例：✅ 任何位置的 `1.`，包括文本内容中的数字

**混合判断逻辑：**
- 两种检测结果数量一致 → 采用首行限制结果（更可信）
- 两种检测结果数量不一致 → 调用 VL 模型辅助判断真实题号数量

**VL 辅助判断机制：**
当规则检测存在歧义时，将文本块对应的图像区域发送给 Qwen-VL 模型，让模型通过视觉分析判断实际包含几道题目，返回题号列表。这样可以结合图像的视觉特征（如题目间距、缩进、排版）进行更准确的判断。

#### 步骤 2: OCR 精确定位每道题目的空间位置

**核心思路：** 使用 PaddleOCR 重新识别文本块，获取每一行文本的精确坐标，通过题号匹配定位每道题目的起止位置。

**详细流程：**

1. **裁剪待拆分文本块的图像区域**
   - 从原始图像中按照文本块的 bbox 坐标裁剪出子图像

2. **调用 PaddleOCR 获取行级坐标**
   - 识别裁剪图像中的所有文本行
   - 获取每行的文本内容、置信度、四点坐标（rec_polys）

3. **匹配题号到具体行**
   - 遍历 OCR 识别的所有行，查找包含目标题号的文本行
   - 获取该行的四点坐标，转换为矩形 bbox

4. **计算每道题目的边界**
   - **顶部边界（top）：**
     - 第一道题：使用原始块的顶部（y1）
     - 后续题：使用题号所在行的顶部坐标
   - **底部边界（bottom）：**
     - 非最后一题：使用下一题题号行的顶部坐标（即当前题的底部紧邻下一题的顶部）
     - 最后一题：使用原始块的底部（y2）
   - **左右边界：** 继承原始块的左右边界（x1、x2）

5. **生成子块**
   - 为每道题目创建新的 DetectionBlock
   - 分配新的唯一 ID（原 ID × 100 + 子块索引）
   - 记录题号（question_number）和拆分标记（split_from_merged=True）

#### 步骤 3: 异常处理与降级策略

**OCR 失败降级：**
- 如果 OCR 未能识别出题号所在的文本行 → 抛出异常，该块不拆分

**完全失败兜底：**
- 如果整个拆分流程失败（如 OCR 调用失败、题号匹配失败等）→ 保持原块不变，记录警告日志

**设计理念：** 宁可不拆分（保持 V1 行为），也不错误拆分，确保系统稳定性。

---

## 实际运行效果对比

### V1 版本问题示例

**输入文本块（block_id=16）：**
```
1. 第一题题干 A. 选项A B. 选项B
2. 第二题题干 A. 选项A B. 选项B
3. 第三题题干 A. 选项A B. 选项B
```

**V1 结果：**
```json
{
  "type": "question",
  "block_ids": [16],  // ❌ 3道题被合并到1个 question 组
  "merged_text": "1. 第一题... 2. 第二题... 3. 第三题..."
}
```

### V2 版本优化后

**Step 2 拆分日志：**
```
[INFO] 块 16 检测到 3 个题号: [1, 2, 3]
[INFO] OCR识别的行级信息为：[
  ('1. 第一题题干 A. 选项A B. 选项B', 0.98, [[10, 5], [500, 5], [500, 50], [10, 50]]),
  ('2. 第二题题干 A. 选项A B. 选项B', 0.97, [[10, 55], [500, 55], [500, 100], [10, 100]]),
  ('3. 第三题题干 A. 选项A B. 选项B', 0.96, [[10, 105], [500, 105], [500, 150], [10, 150]])
]
[INFO] 块 16 拆分完成: 1 → 3 块
```

**V2 拆分结果（_v2_split.json）：**
```json
{
  "blocks": [
    {
      "id": 1600,
      "bbox": [x1, y1, x2, y1+50],
      "text": "1. 第一题题干 A. 选项A B. 选项B",
      "question_number": 1,
      "split_from_merged": true
    },
    {
      "id": 1601,
      "bbox": [x1, y1+55, x2, y1+100],
      "text": "2. 第二题题干 A. 选项A B. 选项B",
      "question_number": 2,
      "split_from_merged": true
    },
    {
      "id": 1602,
      "bbox": [x1, y1+105, x2, y2],
      "text": "3. 第三题题干 A. 选项A B. 选项B",
      "question_number": 3,
      "split_from_merged": true
    }
  ]
}
```

**V2 最终聚合结果（_v2_result.json）：**
```json
{
  "question_groups": [
    {"type": "question", "block_ids": [1600], "merged_text": "1. 第一题..."},
    {"type": "question", "block_ids": [1601], "merged_text": "2. 第二题..."},
    {"type": "question", "block_ids": [1602], "merged_text": "3. 第三题..."}
  ]
}
```

---

## 配置参数

V2 版本新增了拆分相关的配置参数，可以根据实际需求灵活调整。

### 初始化参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `vl_model` | str | "qwen-vl-max" | VL 语义聚合使用的模型 |
| `enable_ocr_fallback` | bool | True | 是否启用二次 OCR 识别（V1 已有） |
| `enable_ocr_split` | bool | True | ✨ 是否启用 OCR 精确拆分（V2 新增） |
| `ocr_model_dir` | str | None | ✨ 本地 OCR 模型路径（V2 新增，可选） |

**使用示例：**
```python
analyzer = ExamPaperAnalyzerVLV2(
    vl_model="qwen-vl-max",
    enable_ocr_split=True,      # 启用拆分功能
    ocr_model_dir=None          # 使用在线模型
)
```

### OCR 拆分相关参数说明

**题号检测支持的格式：**
- 数字加点/顿号：`1.`、`1、`
- 括号格式：`(1)`、`[1]`、`【1】`
- 文字格式：`第1题`

**PaddleOCR 配置（可根据实际效果调整）：**
- 检测阈值：控制文本区域检测的灵敏度
- 识别阈值：控制文本识别的置信度要求
- 扩张系数：调整检测框的大小（值越大框越大）

---

## 适用场景

### V2 优化解决的问题

✅ **适用场景：**
- PaddleOCR VL API 将多道题目合并到一个文本块
- 试卷题目密集排列，版面检测粒度过粗
- 需要精确到单题级别的拆分（如题库录入、自动批改）

❌ **不适用场景：**
- PaddleOCR VL API 已正确拆分题目（无需额外拆分）
- 题目格式不规范，题号检测困难（VL 辅助判断也可能失败）

### 性能考虑

- **额外开销：** 本地 PaddleOCR 推理（每个需拆分的块）
- **时间成本：** 单个块拆分约 1-3 秒（取决于图像大小和 OCR 性能）
- **优化建议：**
  - 仅对 `label="text"` 的块进行拆分检测
  - 使用 GPU 加速 PaddleOCR 推理
  - 缓存 OCR 结果避免重复计算

---

## 总结

V2 版本通过引入 **OCR 精确拆分** 机制，有效解决了 PaddleOCR VL API 合并多题的问题：

1. **精确性提升：** 基于 OCR 行级坐标计算 bbox，空间拆分准确
2. **鲁棒性增强：** 规则检测 + VL 辅助判断，题号识别更可靠
3. **数据完整性：** 保存拆分中间结果，便于调试和验证
4. **向后兼容：** 保留 V1 流程，拆分失败时自动降级

**核心创新：** 在 VL 语义聚合之前，通过本地 OCR + 规则过滤提前拆分合并块，确保每个 question 组只包含一道题目。
