# 坐标缩放问题修复说明

## 问题原因

### 根本原因

**API返回的坐标是基于缩放后的图片，而标注时使用的是原始大小的图片，导致坐标不匹配。**

### 具体表现

从您的案例来看：

```
实际图片尺寸: 6335 x 4475 像素（原图）
JSON中记录的尺寸: 6335 x 4475 像素
但JSON中的坐标值很小: x=25, y=240, width=450

问题：
- API在内部对图片进行了压缩处理
- 返回的坐标是基于压缩后的图片
- 但JSON中记录的是原图尺寸
- 标注时使用原图，导致坐标都挤在左上角很小的区域
```

### 缩放比例计算

根据提示"Multiply coordinates by 3.17"，说明：
- API将图片缩小到约 `2000 x 1413` 像素
- 缩放比例 = `6335 / 2000 ≈ 3.17`

## 解决方案

### 方案1：使用更新后的脚本（推荐）

更新后的 `exam_paper_splitter_v2.py` 已经内置了自动缩放检测和修正功能。

**智能检测逻辑：**
```python
# 1. 计算理论缩放比例
scale_x = 实际宽度 / JSON记录宽度
scale_y = 实际高度 / JSON记录高度

# 2. 智能检测是否真的需要缩放
# 如果第一个题目的最大坐标 < 图片尺寸的1/3
# 说明坐标尺度不匹配，需要应用缩放
if max_coord < min(width, height) / 3:
    应用缩放
else:
    不需要缩放（坐标已经正确）
```

**运行效果：**
```
⚠️  检测到坐标尺度不匹配！
   实际图片: 6335x4475
   JSON记录: 6335x4475
   坐标最大值: 950
   应用缩放: 6.67x (横), 3.17x (纵)
```

### 方案2：使用重新标注工具

对于已经生成的JSON文件，可以使用 `redraw_annotations.py` 重新标注：

```bash
python redraw_annotations.py output/1_questions_v2.json data/shuxue/1.png
```

**输出：**
```
图片尺寸信息:
  实际图片: 6335x4475
  JSON记录: 6335x4475

⚠️  检测到坐标尺度不匹配！
   坐标最大值: 950
   应用缩放: 6.67x (横), 3.17x (纵)

✓ 标注图片已保存: data/shuxue/1_reannotated.jpg
  共标注 14 道题目
```

## 使用方法

### 方法A：重新运行识别（推荐）

使用更新后的脚本重新识别：

```bash
python exam_paper_splitter_v2.py data/shuxue/1.png
```

新的标注图片会自动应用正确的坐标缩放。

### 方法B：仅重新标注

如果不想重新识别，只想基于现有JSON重新标注：

```bash
# 基本用法
python redraw_annotations.py output/1_questions_v2.json data/shuxue/1.png

# 指定输出路径
python redraw_annotations.py \
  output/1_questions_v2.json \
  data/shuxue/1.png \
  --output output/1_fixed.jpg
```

## 技术细节

### 缩放应用位置

所有涉及坐标的地方都需要应用缩放：

#### 1. 标注绘制 (draw_annotations)
```python
# 题目边界
x = int(bbox["x"] * scale_x)
y = int(bbox["y"] * scale_y)
w = int(bbox["width"] * scale_x)
h = int(bbox["height"] * scale_y)

# 填空区域
x = int(blank_bbox["x"] * scale_x)
y = int(blank_bbox["y"] * scale_y)
...

# 选项区域
x = int(option_bbox["x"] * scale_x)
...

# 答题区域
x = int(answer_bbox["x"] * scale_x)
...
```

#### 2. 题目裁剪 (crop_questions)
```python
# 裁剪题目时也要应用缩放
x = int(bbox["x"] * scale_x)
y = int(bbox["y"] * scale_y)
w = int(bbox["width"] * scale_x)
h = int(bbox["height"] * scale_y)

# 裁剪图上的相对坐标也要缩放
b_x = int(blank_bbox["x"] * scale_x) - x
b_y = int(blank_bbox["y"] * scale_y) - y
```

### 智能检测原理

```python
# 获取第一个题目的坐标范围
first_bbox = questions[0]["full_bbox"]
max_coord = max(
    first_bbox["x"] + first_bbox["width"],
    first_bbox["y"] + first_bbox["height"]
)

# 如果最大坐标很小，说明坐标是基于缩放后的图片
# 阈值设为图片尺寸的1/3
threshold = min(width, height) / 3

if max_coord < threshold:
    # 需要缩放
    scale_x = actual_width / recorded_width
    scale_y = actual_height / recorded_height
else:
    # 不需要缩放
    scale_x = 1.0
    scale_y = 1.0
```

### 为什么会出现这个问题？

1. **API内部压缩**：视觉API为了处理效率，内部对大图片进行了压缩
2. **坐标返回**：API返回的坐标是基于压缩后的图片
3. **尺寸记录错误**：脚本在保存JSON时记录的是原图尺寸，而不是API实际处理的图片尺寸
4. **标注不匹配**：标注时使用原图，但坐标是压缩图的，导致位置错误

### 修复后的改进

1. **自动检测**：智能判断坐标是否需要缩放
2. **自动修正**：根据图片尺寸自动计算并应用缩放比例
3. **全面应用**：在所有绘制和裁剪操作中都应用缩放
4. **调试信息**：输出详细的缩放信息，方便排查问题

## 验证方法

标注正确的特征：
1. ✅ 黄色框准确框住填空位置
2. ✅ 黄色框不会全部挤在左上角
3. ✅ 题目边界（红色框）覆盖整道题目
4. ✅ 标签位置正确显示在填空上方

标注错误的特征：
1. ❌ 所有框都挤在图片左上角很小的区域
2. ❌ 框的位置与实际填空位置不对应
3. ❌ 题目边界很小，没有覆盖完整题目

## 常见问题

### Q1: 为什么JSON中记录的尺寸是正确的，但坐标还是不对？

A: 因为API在内部对图片进行了处理，返回的坐标是基于处理后的图片。虽然JSON记录了原图尺寸，但坐标值是压缩后的。

### Q2: 缩放比例为什么不是整数？

A: API的压缩比例不固定，取决于原图大小。通常会压缩到2000px左右的宽度，所以比例因原图而异。

### Q3: 如何判断是否需要重新标注？

A: 打开标注图片查看：
- 如果黄色框都挤在左上角 → 需要重新标注
- 如果黄色框位置正确 → 不需要处理

### Q4: 重新运行识别会产生不同的结果吗？

A: 坐标位置可能略有不同（AI识别的随机性），但缩放处理是确定的。建议使用重新标注工具，这样保留原有识别结果。

## 总结

✅ **已修复的问题：**
- exam_paper_splitter_v2.py 自动检测并修正坐标缩放
- redraw_annotations.py 可对已有JSON重新标注
- 所有坐标操作都正确应用缩放比例

✅ **使用建议：**
1. 新图片：直接使用更新后的 exam_paper_splitter_v2.py
2. 已有JSON：使用 redraw_annotations.py 重新标注
3. 检查结果：查看标注图片确认黄色框位置正确

如有问题，请检查：
1. 图片路径是否正确
2. JSON文件格式是否完整
3. 输出的调试信息中的缩放比例
