# 试卷题目拆分工具 V2 使用说明

## 功能概述

该工具能够自动识别试卷图片中的每道题目，并以**黄色框**标注每个填空/作答位置，仿照参考图片的标注方式。

### 主要功能

1. **题目识别**：自动识别试卷中的所有题目（选择题、填空题、解答题、判断题等）
2. **精确定位**：精确定位每个填空位置、选项圆圈、答题区域
3. **黄色框标注**：用黄色矩形框标注所有填空和作答区域
4. **结构化输出**：输出包含详细坐标信息的JSON文件
5. **图片裁剪**：自动裁剪每道题目的单独图片

## 参考样式

工具模仿的标注样式：
- **黄色框**：框选每个填空位置
- **橙色标签**：显示题号和填空序号（如 "1-1", "1-2"）
- **精确框选**：框的大小恰好包含填空区域

## 安装依赖

```bash
pip install opencv-python numpy openai
```

## 环境配置

设置API密钥（二选一）：

**方法1：环境变量**
```bash
# Windows
set ARK_API_KEY=your_api_key_here

# Linux/Mac
export ARK_API_KEY=your_api_key_here
```

**方法2：命令行参数**
```bash
python exam_paper_splitter_v2.py exam.jpg --api-key your_api_key_here
```

## 使用方法

### 基本用法

```bash
python exam_paper_splitter_v2.py 试卷图片.jpg
```

默认输出：
- `output/试卷图片_questions_v2.json` - 结构化JSON数据
- `output/试卷图片_annotated.jpg` - 黄色框标注图片
- `output/试卷图片_questions/` - 每道题目的单独图片

### 高级用法

```bash
python exam_paper_splitter_v2.py exam.jpg \
  --output-json result/questions.json \
  --output-annotated result/marked.jpg \
  --output-cropped result/questions/ \
  --no-labels
```

### 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `image` | 输入试卷图片路径（必需） | `exam.jpg` |
| `--output-json` | 输出JSON文件路径 | `result.json` |
| `--output-annotated` | 输出标注图片路径 | `marked.jpg` |
| `--output-cropped` | 输出裁剪题目目录 | `questions/` |
| `--no-labels` | 不显示标签（只显示黄色框） | - |
| `--api-key` | API密钥 | `sk-xxx` |
| `--base-url` | API基础URL | `https://...` |

## 输出格式

### JSON数据结构

```json
{
  "image_info": {
    "source_path": "exam.jpg",
    "width": 1920,
    "height": 2560,
    "processed_time": "2025-12-24T10:30:00"
  },
  "questions": [
    {
      "question_id": "Q1",
      "question_number": "1",
      "question_type": "填空题",
      "full_bbox": {
        "x": 100,
        "y": 200,
        "width": 800,
        "height": 150,
        "description": "题目完整区域"
      },
      "blank_areas": [
        {
          "blank_id": "Q1_B1",
          "blank_number": 1,
          "bbox": {
            "x": 300,
            "y": 220,
            "width": 80,
            "height": 30
          },
          "blank_type": "下划线",
          "description": "第1个填空位置"
        },
        {
          "blank_id": "Q1_B2",
          "blank_number": 2,
          "bbox": {
            "x": 500,
            "y": 220,
            "width": 80,
            "height": 30
          },
          "blank_type": "括号",
          "description": "第2个填空位置"
        }
      ],
      "confidence": 0.95
    },
    {
      "question_id": "Q2",
      "question_number": "2",
      "question_type": "选择题",
      "full_bbox": {
        "x": 100,
        "y": 400,
        "width": 800,
        "height": 200
      },
      "option_areas": [
        {
          "option_id": "Q2_OPT_A",
          "option_label": "A",
          "bbox": {
            "x": 200,
            "y": 450,
            "width": 25,
            "height": 25
          },
          "description": "选项A的圆圈"
        },
        {
          "option_id": "Q2_OPT_B",
          "option_label": "B",
          "bbox": {
            "x": 400,
            "y": 450,
            "width": 25,
            "height": 25
          },
          "description": "选项B的圆圈"
        }
      ],
      "confidence": 0.92
    },
    {
      "question_id": "Q3",
      "question_number": "3",
      "question_type": "解答题",
      "full_bbox": {
        "x": 100,
        "y": 650,
        "width": 800,
        "height": 400
      },
      "answer_area": {
        "bbox": {
          "x": 100,
          "y": 750,
          "width": 800,
          "height": 300
        },
        "description": "答题区域"
      },
      "confidence": 0.88
    }
  ],
  "statistics": {
    "total_questions": 3,
    "total_blanks": 2,
    "total_options": 2,
    "by_type": {
      "填空题": 1,
      "选择题": 1,
      "解答题": 1
    }
  }
}
```

### 字段说明

#### 题目级别字段
- `question_id`: 题目唯一标识（Q1, Q2, ...）
- `question_number`: 试卷上的题号（"1", "2", "一", "二"等）
- `question_type`: 题目类型
  - `填空题`: 有下划线、括号或方框填空
  - `选择题`: 有A/B/C/D等选项
  - `解答题`: 有较大答题区域
  - `判断题`: 有对/错或√/×
  - `计算题`: 需要计算演算的题目
- `full_bbox`: 题目完整区域的边界框
- `confidence`: 识别置信度（0-1）

#### 填空题字段
- `blank_areas`: 填空位置数组
  - `blank_id`: 填空唯一标识
  - `blank_number`: 填空序号（1, 2, 3, ...）
  - `bbox`: 填空位置的坐标
  - `blank_type`: 填空类型（下划线/括号/方框）

#### 选择题字段
- `option_areas`: 选项数组
  - `option_id`: 选项唯一标识
  - `option_label`: 选项标签（A, B, C, D）
  - `bbox`: 选项圆圈的坐标

#### 解答题字段
- `answer_area`: 答题区域
  - `bbox`: 答题区域的坐标

#### 坐标字段
所有 `bbox` 对象包含：
- `x`: 左上角X坐标（像素）
- `y`: 左上角Y坐标（像素）
- `width`: 宽度（像素）
- `height`: 高度（像素）

## 标注图片说明

生成的标注图片包含：

1. **红色细框**：题目完整边界（用于调试）
2. **黄色粗框**：填空/选项/答题区域（主要标注）
3. **橙色标签**：题号和序号（如"1-1"表示第1题第1个填空）

## 使用示例

### 示例1：处理单张试卷

```bash
python exam_paper_splitter_v2.py data/math_exam.jpg
```

输出：
```
正在读取图片: data/math_exam.jpg
图片尺寸: 1920x2560
正在调用视觉API...
API返回内容长度: 3256 字符
识别完成，共识别到 10 道题目
JSON结果已保存: output/math_exam_questions_v2.json
标注图片已保存: output/math_exam_annotated.jpg
已裁剪 10 道题目的单独图片

统计信息
总题目数: 10
总填空数: 15
总选项数: 20
题目类型分布:
  填空题: 5
  选择题: 5
```

### 示例2：自定义输出路径

```bash
python exam_paper_splitter_v2.py exam.jpg \
  --output-json results/exam_data.json \
  --output-annotated results/exam_marked.jpg \
  --output-cropped results/questions/
```

### 示例3：不显示标签（纯黄色框）

```bash
python exam_paper_splitter_v2.py exam.jpg --no-labels
```

## 注意事项

### 图片质量要求
- **分辨率**：建议宽度 ≥ 1200px
- **清晰度**：文字清晰可辨，无模糊
- **光线**：均匀光线，避免阴影和反光
- **角度**：正面拍摄，避免倾斜

### 识别准确性
- 题号清晰可见（"1."、"2."等）
- 填空位置明显（下划线、括号、方框）
- 选项标记清楚（A/B/C/D及圆圈）
- 题目间有明显分隔

### 常见问题

**Q: 为什么有些填空没有识别到？**
A: 可能是填空标记不明显，建议：
- 确保下划线清晰
- 括号填空要有明显的括号
- 图片质量足够高

**Q: 坐标不准确怎么办？**
A: 工具会自动修正坐标，但如果仍有问题：
- 提高图片分辨率
- 确保图片无倾斜
- 检查题目排版是否规范

**Q: 如何处理分栏试卷？**
A: 工具会自动按"先左栏后右栏"的顺序识别

**Q: 支持哪些题目类型？**
A: 支持：
- 填空题（下划线、括号、方框）
- 选择题（A/B/C/D选项）
- 解答题（答题区域）
- 判断题（对/错）
- 计算题（演算区域）

## 技术细节

### 工作流程

1. **图片读取**：读取试卷图片并获取尺寸
2. **API调用**：调用视觉API进行题目识别
3. **JSON解析**：解析API返回的JSON结果
4. **坐标验证**：验证并修正坐标范围
5. **标注绘制**：在原图上绘制黄色框标注
6. **题目裁剪**：裁剪每道题目的单独图片
7. **结果保存**：保存JSON、标注图片、裁剪图片

### 提示词设计

工具使用精心设计的提示词，确保：
- 准确识别题号和题目边界
- 精确定位每个填空位置
- 正确区分不同题目类型
- 处理一题多空的情况
- 避免遗漏或重复

### 颜色定义

```python
YELLOW = (0, 255, 255)   # 填空框颜色
ORANGE = (0, 165, 255)   # 标签背景色
WHITE = (255, 255, 255)  # 标签文字色
RED = (0, 0, 255)        # 题目边界色（调试用）
```

## 版本历史

### V2.0 (2025-12-24)
- ✨ 新增黄色框标注样式
- ✨ 精确识别填空位置
- ✨ 支持多种填空类型
- ✨ 支持选择题选项标注
- ✨ 优化提示词设计
- 📝 完善JSON输出格式

### V1.0
- 基础题目识别功能
- 简单框选标注

## 许可证

内部使用工具

## 联系方式

如有问题，请联系开发团队。
